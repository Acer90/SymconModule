/*!
 * chartjs-plugin-streaming v2.0.0-beta.2
 * https://nagix.github.io/chartjs-plugin-streaming
 * (c) 2017-2021 Akihiko Kusanagi
 * Released under the MIT license
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("chart.js/helpers")):"function"==typeof define&&define.amd?define(["chart.js","chart.js/helpers"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).ChartStreaming=t(e.Chart,e.Chart.helpers)}(this,(function(e,t){"use strict";function o(e,t,o){return Math.min(Math.max(e,t),o)}function a(e,o){const a=e.options.realtime,n=e.chart.options.plugins.streaming;return t.valueOrDefault(a[o],n[o])}const n="undefined"==typeof window?t.noop:window.cancelAnimationFrame;function i(e,o){if(!e.frameRequestID){const a=function(){o(),e.frameRequestID=t.requestAnimFrame.call(window,a)};e.frameRequestID=t.requestAnimFrame.call(window,a)}}function r(e){const t=e.frameRequestID;t&&(n.call(window,t),delete e.frameRequestID)}const s=new WeakMap;function l(e){const{originalScaleLimits:o}=function(e){let t=s.get(e);return t||(t={originalScaleLimits:{}},s.set(e,t)),t}(e),n=e.scales;return t.each(n,(e=>{const t=e.id;o[t]||(o[t]={duration:a(e,"duration"),delay:a(e,"delay")})})),t.each(o,((e,t)=>{n[t]||delete o[t]})),o}function c(e,t,n,i){const{chart:r,axis:s}=e,{minDuration:c=0,maxDuration:d=1/0,minDelay:u=-1/0,maxDelay:m=1/0}=i&&i[s]||{},f=e.options.realtime,p=a(e,"duration"),h=a(e,"delay"),g=o(p*(2-t),c,d);let y,b;return l(r),y=e.isHorizontal()?(e.right-n.x)/(e.right-e.left):(e.bottom-n.y)/(e.bottom-e.top),b=h+y*(p-g),f.duration=g,f.delay=o(b,u,m),g!==e.max-e.min}function d(e,t,n){const{chart:i,axis:r}=e,{minDelay:s=-1/0,maxDelay:c=1/0}=n&&n[r]||{},d=a(e,"delay")+(e.getValueForPixel(t)-e.getValueForPixel(0));return l(i),e.options.realtime.delay=o(d,s,c),!0}const u={millisecond:{common:!0,size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{common:!0,size:1e3,steps:[1,2,5,10,15,30]},minute:{common:!0,size:6e4,steps:[1,2,5,10,15,30]},hour:{common:!0,size:36e5,steps:[1,2,3,6,12]},day:{common:!0,size:864e5,steps:[1,2,5]},week:{common:!1,size:6048e5,steps:[1,2,3,4]},month:{common:!0,size:2628e6,steps:[1,2,3]},quarter:{common:!1,size:7884e6,steps:[1,2,3,4]},year:{common:!0,size:3154e7}},m=Object.keys(u);function f(e,o,a){if(a){if(a.length){const{lo:n,hi:i}=t._lookup(a,o);e[a[n]>=o?a[n]:a[i]]=!0}}else e[o]=!0}function p(e,t){return t===e.xAxisID?"x":t===e.yAxisID&&"y"}const h=["pointBackgroundColor","pointBorderColor","pointBorderWidth","pointRadius","pointRotation","pointStyle","pointHitRadius","pointHoverBackgroundColor","pointHoverBorderColor","pointHoverBorderWidth","pointHoverRadius","backgroundColor","borderColor","borderSkipped","borderWidth","hoverBackgroundColor","hoverBorderColor","hoverBorderWidth","hoverRadius","hitRadius","radius","rotation"];function g(e){const t=e.realtime,o=t.refreshTimerID;o&&(clearInterval(o),delete t.refreshTimerID,delete t.refreshInterval)}function y(e){const o=e.realtime,n=a(e,"refresh");o.refreshTimerID||(o.refreshTimerID=setInterval((()=>{const n=a(e,"refresh");!function(e){const{chart:o,id:n,max:i}=e,r=a(e,"duration"),s=a(e,"delay"),l=a(e,"ttl"),c=a(e,"pause"),d=a(e,"onRefresh"),u=Date.now()-(isNaN(l)?r+s:l);let m,f,g,y;t.callback(d,[o]),o.data.datasets.forEach(((e,a)=>{const r=o.getDatasetMeta(a),s=p(r,n);if(s){const o=r.controller,a=e.data,n=a.length;if(c){for(m=0;m<n&&o.getParsed(m)[s]<i;++m);f=m+2}else f=0;for(m=f;m<n&&o.getParsed(m)[s]<=u;++m);g=m-f,isNaN(l)&&(g=Math.max(g-2,0)),a.splice(f,g),h.forEach((o=>{t.isArray(e[o])&&e[o].splice(f,g)})),t.each(e.datalabels,(e=>{t.isArray(e)&&e.splice(f,g)})),"object"!=typeof a[0]&&(y={start:f,count:g})}})),y&&o.data.labels.splice(y.start,y.count),o.update("quiet")}(e),o.refreshInterval===n||isNaN(n)||(g(e),y(e))}),n),o.refreshInterval=n)}const b={data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},v={data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]};function x(e,t,o){const a=e.$animations;for(let a=0,n=t.length;a<n;++a){const n=t[a];isNaN(e[n])||(e[n]-=o)}if(a)for(let e=0,n=t.length;e<n;++e){const n=a[t[e]];n&&(n._from-=o,n._to-=o)}}class D extends e.TimeScale{constructor(e){super(e),this.realtime=this.realtime||{}}init(e,t){super.init(e,t),y(this)}update(e,o,n){const s=this,{realtime:l,options:c}=s,{bounds:d,offset:u,ticks:m}=c,{autoSkip:f,source:h,major:g}=m,y=g.enabled;a(s,"pause")?r(l):(i(l,(()=>{!function(e){const{chart:o,id:n,realtime:i}=e,r=a(e,"duration"),s=a(e,"delay"),l=e.isHorizontal(),c=o.tooltip,d=c._active,u=Date.now();let m,f,h;l?(m=e.width,f=b):(m=e.height,f=v),h=m*(u-i.head)/r,!!l==!!e.options.reverse&&(h=-h),t.each(o.data.datasets,((e,t)=>{const a=o.getDatasetMeta(t);if(p(a,n)){const{data:e,dataset:t}=a,o=e||[];for(let e=0,t=o.length;e<t;++e)x(o[e],f.data,h);t&&x(t,f.dataset,h)}})),d&&d[0]&&p(o.getDatasetMeta(d[0].datasetIndex),n)&&x(c,f.tooltip,h);e.max=u-s,e.min=e.max-r,i.head=u}(s)})),l.head=Date.now()),c.bounds=void 0,c.offset=!1,m.autoSkip=!1,m.source="auto"===h?"":h,g.enabled=!0,super.update(e,o,n),c.bounds=d,c.offset=u,m.autoSkip=f,m.source=h,g.enabled=y}buildTicks(){const e=this,o=a(e,"duration"),n=a(e,"delay"),i=e.realtime.head-n,r=i-o,s=[1e15,i],l=[-1e15,r];Object.defineProperty(e,"min",{get:()=>l.shift(),set:t.noop}),Object.defineProperty(e,"max",{get:()=>s.shift(),set:t.noop});const c=super.buildTicks();return delete e.min,delete e.max,e.min=r,e.max=i,c}calculateLabelRotation(){const e=this.options.ticks,t=e.maxRotation;e.maxRotation=e.minRotation||0,super.calculateLabelRotation(),e.maxRotation=t}fit(){const e=this,t=e.options;super.fit(),t.ticks.display&&t.display&&e.isHorizontal()&&(e.paddingLeft=3,e.paddingRight=3,e._handleMargins())}draw(e){const o=this,{chart:a,ctx:n}=o,i=o.isHorizontal()?{left:e.left,top:0,right:e.right,bottom:a.height}:{left:0,top:e.top,right:a.width,bottom:e.bottom};o._gridLineItems=null,o._labelItems=null,t.clipArea(n,i),super.draw(e),t.unclipArea(n)}destroy(){r(this.realtime),g(this)}_generate(){const e=this,o=e._adapter,n=a(e,"duration"),i=a(e,"delay"),r=a(e,"refresh"),s=e.realtime.head-i,l=s-n,c=e._getLabelCapacity(l),{time:d,ticks:p}=e.options,h=d.unit||function(e,t,o,a){const n=o-t,i=m.length;for(let t=m.indexOf(e);t<i-1;++t){const{common:e,size:o,steps:i}=u[m[t]],r=i?i[i.length-1]:Number.MAX_SAFE_INTEGER;if(e&&Math.ceil(n/(r*o))<=a)return m[t]}return m[i-1]}(d.minUnit,l,s,c),g=function(e){for(let t=m.indexOf(e)+1,o=m.length;t<o;++t)if(u[m[t]].common)return m[t]}(h),y=d.stepSize||function(e,t,o,a){const n=t-e,{size:i,steps:r}=u[o];let s;if(!r)return Math.ceil(n/(a*i));for(let e=0,t=r.length;e<t&&(s=r[e],!(Math.ceil(n/(i*s))<=a));++e);return s}(l,s,h,c),b="week"===h&&d.isoWeekday,v=p.major.enabled,x=t.isNumber(b)||!0===b,D=u[h],w={};let k,I,R=l;if(x&&(R=+o.startOf(R,"isoWeek",b)),R=+o.startOf(R,x?"day":h),o.diff(s,l,h)>1e5*y)throw new Error(l+" and "+s+" are too far apart with stepSize of "+y+" "+h);k=R,v&&g&&!x&&!d.round&&(k=+o.startOf(k,g),k=+o.add(k,~~((R-k)/(D.size*y))*y,h));const z="data"===p.source&&e.getDataTimestamps();for(I=0;k<s+r;k=+o.add(k,y,h),I++)f(w,k,z);return k!==s+r&&1!==I||f(w,k,z),Object.keys(w).sort(((e,t)=>e-t)).map((e=>+e))}}D.id="realtime",D.defaults={bounds:"data",adapters:{},time:{parser:!1,unit:!1,round:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{}},realtime:{},ticks:{autoSkip:!1,source:"auto",major:{enabled:!0}}},e.defaults.describe("scale.realtime",{_scriptable:e=>"onRefresh"!==e});var w={id:"streaming",version:"2.0.0-beta.2",beforeInit(e){const o=e.streaming=e.streaming||{},a=o.canvas=e.canvas,n=o.mouseEventListener=a=>{const n=t.getRelativePosition(a,e);o.lastMouseEvent={type:"mousemove",chart:e,native:a,x:n.x,y:n.y}};a.addEventListener("mousedown",n),a.addEventListener("mouseup",n),e.options.transitions.quiet={animation:{duration:0}}},afterInit(o){const{update:a,render:n,resetZoom:i}=o;if(o.update=e=>{"quiet"===e?(o.render=t.noop,a.call(o,e),o.render=n):a.call(o,e)},i){const a=e.registry.getPlugin("zoom");a.zoomFunctions.realtime=c,a.panFunctions.realtime=d,o.resetZoom=e=>{!function(e){const o=l(e);t.each(e.scales,(e=>{const t=e.options.realtime;if(t){const a=o[e.id];a?(t.duration=a.duration,t.delay=a.delay):(delete t.duration,delete t.delay)}}))}(o),i(e)}}},beforeUpdate(e){const t=e.options,o=t.scales;return o&&Object.keys(o).forEach((e=>{"realtime"===o[e].type&&(t.elements.line.capBezierPoints=!1)})),!0},afterUpdate(e){const{scales:o,streaming:n}=e;let s=!0;t.each(o,(e=>{e instanceof D&&(s&=a(e,"pause"))})),s?r(n):i(n,(()=>{!function(e){const t=e.streaming,o=e.options.plugins.streaming.frameRate,a=1e3/(Math.max(o,0)||30),n=t.lastDrawn+a||0,i=Date.now();n<=i&&(e.render(),t.lastMouseEvent&&setTimeout((()=>{const o=t.lastMouseEvent;o&&e._eventHandler(o)}),0),t.lastDrawn=n+a>i?n:i)}(e)}))},beforeDatasetDraw(e,o){const{ctx:a,chartArea:n,width:i,height:r}=e,{xAxisID:s,yAxisID:l,controller:c}=o.meta,d={left:0,top:0,right:i,bottom:r};return s&&c.getScaleForId(s)instanceof D&&(d.left=n.left,d.right=n.right),l&&c.getScaleForId(l)instanceof D&&(d.top=n.top,d.bottom=n.bottom),t.clipArea(a,d),!0},afterDatasetDraw(e){t.unclipArea(e.ctx)},beforeEvent(e,t){const o=e.streaming,a=t.event;return"mousemove"===a.type?o.lastMouseEvent=a:"mouseout"===a.type&&delete o.lastMouseEvent,!0},destroy(e){const{scales:o,streaming:a}=e,{canvas:n,mouseEventListener:i}=a;r(a),n.removeEventListener("mousedown",i),n.removeEventListener("mouseup",i),t.each(o,(e=>{e instanceof D&&e.destroy()}))},defaults:{duration:1e4,delay:0,frameRate:30,refresh:1e3,onRefresh:null,pause:!1,ttl:void 0},descriptors:{_scriptable:e=>"onRefresh"!==e}};return e.Chart.register(w,D),w}));
