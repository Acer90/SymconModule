<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {VIEWPORT} <!-- Dont Remove this line, it can be disabled at intstance! -->
    <title>ColorPicker</title>
</head>
<script src="/hook/JSLive/js/jquery.min.js"></script>
<script src="/hook/JSLive/js/util.js"></script>
<!--<script src="/hook/JSLive/js/iro/5.5.0/iro.js"></script>-->

<script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>



<body style="text-align: center;">
<div id="picker"></div>

<script>
    let config_global = {GLOBAL};
    let config_variabels = {VARIABELS};
    let config_layout = {LAYOUT};
    let configuration = {CONFIG};

    let colors_ids = [];
    let colorsTemperatures_ids = [];
    let colorsTemperaturesMode_ids = [];

    let colorPicker = new iro.ColorPicker("#picker",  LoadPicker());

    let last_update = Date.now();
    let updateId = [];
    let updateVal = [];
    let running = false;

    function LoadPicker(){

            var laydata = GenerateLayoutData();
            var wdh = window.innerHeight - 20;

            if (wdh > window.innerWidth) {
                wdh = window.innerWidth - 20;
            }

            if (configuration.manWidth > 0) {
                wdh = configuration.manWidth;
            }

            //alert("Breite: " + wdh);

            if (configuration.layout_Direction === "vertical") {
                wdh = wdh - laydata.width_s;

                if (laydata.counter_wheelbox > 0) {
                    wdh = (wdh / laydata.counter_wheelbox) - (laydata.counter_wheelbox * 10);
                }
            }

            config = {
                layoutDirection: configuration.layout_Direction,
                layout: laydata.output,
                colors: GenerateColorData(),
                width: wdh,
                borderColor: configuration.style_borderColor,
                borderWidth: configuration.style_borderWidth,
                handleRadius: configuration.style_handleRadius
                //handleSvg: '#handle',
                //handleProps: {x: -8, y: -20}

            };

            //config = {};

            return config;
        try {
        }catch (e){
            alert("Colorpicker | ",e);
        }
    }

    function GenerateLayoutData(){
        var output = [];
        var width_s = 0;
        var counter_wheelbox = 0;

        config_layout.forEach(function (part, index){
            item = {};
            options = {};

            switch(part.Layout){
                default:
                case "Wheel":
                    item["component"] = iro.ui.Wheel;
                    options["wheelLightness"] = configuration.wheel_Lightness;
                    options["wheelAngle"] = configuration.wheel_Angle;
                    options["wheelDirection"] = configuration.wheel_Direction;
                    counter_wheelbox++;
                    break;
                case "Box":
                    item["component"] = iro.ui.Box;
                    counter_wheelbox++;
                    break;
                case "Slider":
                    item["component"] = iro.ui.Slider;
                    if(part.sliderShape === "circle"){
                        counter_wheelbox++;
                    }else{
                        width_s = width_s + part.sliderSize + 10;
                    }


                    options["sliderType"] = part.sliderType;
                    options["sliderSize"] = part.sliderSize;
                    options["sliderShape"] = part.sliderShape;
                    break;
            }
            item["component"]

            item["options"] = options;
            output.push(item);
        });

        if(output.length === 0){
            //add default!
            //Wheel
            item = {};
            options = {};

            item["component"] = iro.ui.Wheel;
            output.push(item);
            counter_wheelbox++;

            //silder Value
            item = {};
            options = {};

            item["component"] = iro.ui.Slider;
            options["sliderType"] = "value";
            options["sliderSize"] = 40;
            item["options"] = options;
            output.push(item);
            width_s = width_s + 40 + 10;
        }

        return {"output": output, "width_s": width_s, "counter_wheelbox": counter_wheelbox};
    }
    function GenerateColorData(){
        var output = [];

        colors_ids = [];
        colorsTemperatures_ids = [];
        colorsTemperaturesMode_ids = [];

        config_variabels.forEach(function (part, index){
            if(part.Color.Variable === 0 && part.Temperature.Variable === 0){
                console.log("Überspinge Farbe => keine avriable gesetzt!");
            }else{
                if(part.Mode.Variable > 0 && part.Mode.Value){
                    //temperture Mode
                    temp = part.Temperature.Value;

                    if(part.Temperature.isMired){
                        temp = MiredToKelvin(temp);
                    }
                    output.push(colorTemperatureToRGB(temp));
                }else{
                    //color Mode
                    output.push(hexToRgb(part.Color.Value));
                }

                colors_ids.push(part.Color.Variable);
                colorsTemperatures_ids.push(part.Temperature.Variable);
                colorsTemperaturesMode_ids.push(part.Mode.Variable);

            }
        });

        return output;
    }

    colorPicker.on('color:change', function(color) {
        console.log(Date.now() + " >> ChangeColor (" + color.index + ") => " + color.rgb);

        id = config_variabels[color.index].Color.Variable;
        val = hexToInt(color.rgb);

        val2 = color.kelvin;
        if(config_variabels[color.index].Temperature.isMired){
            val2 = KelvinToMired(val2);
        }

        config_variabels[color.index].Color.Value = val;
        config_variabels[color.index].Temperature.Value = val;

        if(config_variabels[color.index].Mode.Value){
            id = config_variabels[color.index].Temperature.Variable;
            val = val2;

        }

        if(updateId.includes(id)){
            //updaten
            index = updateId.indexOf(id);
            updateVal[index] = val;
        }else{
            //anlegen
            updateId.push(id);
            updateVal.push(val);
        }

        console.log(Date.now() + " >> ChangeColor => "+ JSON.stringify(updateVal));

        if(!running) UpdateWorker();
    });

    async function UpdateWorker(){
        running = true;
        while (running){
            await sleep(1);
            try {
                //console.log("UpdateWorker => "+ updateVal.length + " | " + updateId.length);
                if((last_update + configuration.DataUpdateRate) <= Date.now() && updateVal.length > 0 && updateId.length > 0){
                    last_update = Date.now();
                    //console.log("UpdateWorker => "+ JSON.stringify(updateVal) + " | " + JSON.stringify(updateId));

                    for (i = 0; i < updateVal.length; i++) {
                        console.log(Date.now() + " >> UpdateWorker | Update " + JSON.stringify(updateVal) + " | " + JSON.stringify(updateId));
                        console.log(Date.now() + " >> UpdateWorker | URL: /hook/JSLive/setData?Instance={INSTANCE}&pw={PASSWORD}&var=" +updateId[i]+ "&val="+updateVal[i]);
                        var response = await fetch("/hook/JSLive/setData?Instance={INSTANCE}&pw={PASSWORD}&var=" +updateId[i]+ "&val="+updateVal[i]);
                        console.log(Date.now() + " >> UpdateWorker Response => " + response.statusText + " (" + response.status + ")");
                    }

                    updateVal = [];
                    updateId = [];

                    console.log(Date.now() + " >> UpdateWorker => CLOSE");
                    running = false;
                }
            }catch (e) {
                console.log(Date.now() + " >> UpdateWorker => ", e);
            }
        }
    }

    function connect() {
        let location = window.detectLocation();
        var ws = new WebSocket(location['protocol'].replace(/^http/, 'ws') + "//" + location['host'] + "/hook/JSLive/WS/" + {INSTANCE});
        ws.onopen = function() {
            // subscribe to some channels
            //ws.send(JSON.stringify({
            //.... some message the I must send when I connect ....
            //}));
        };

        ws.onmessage = function(e) {
            data = JSON.parse(e.data);
            if(data.Message == 10506) {
                //refresh webseite
                setTimeout(function (){
                    location.reload();
                },1000);
            } else if(data.Message == 10603) {
                UpdateColorPicker(data.SenderID, data.Data[0]);
            }
        };

        ws.onclose = function(e) {
            console.log(Date.now() + ' >> Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
            setTimeout(function() {
                connect();
            }, 1000);
        };

        ws.onerror = function(err) {
            console.error(Date.now() + ' >> Socket encountered error: ', err.message, 'Closing socket');
            ws.close();
        };
    }

    function UpdateColorPicker(id_val, val){
        isUpdated = false;
        now = Date.now();
        if(running ) return;

        if(colors_ids.includes(id_val)){
            //änderung farbe
            index = colors_ids.indexOf(id_val);

            if(config_variabels[index].Color.Value !== val){
                console.log(Date.now() + " >> UpdateColorPicker (Color)" + index + " => " + val+ " (" + config_variabels[index].Color.Value + ")");
                config_variabels[index].Color.Value = val;
                isUpdated = true;
            }
        }

        if(colorsTemperatures_ids.includes(id_val)){
            //änderung temperture!!
            index = colorsTemperatures_ids.indexOf(id_val);

            if(config_variabels[index].Temperature.Value !== val){
                config_variabels[index].Temperature.Value = val;
                console.log(Date.now() + " >> UpdateColorPicker (Temp)" + index + " => " + val+ " (" + config_variabels[index].Temperature.Value + ")");
                isUpdated = true;
            }
        }

        if(colorsTemperaturesMode_ids.includes(id_val)){
            //änderung des Moduses
            index =  colorsTemperaturesMode_ids.indexOf(id_val);

            if(config_variabels[index].Mode.Value !== val){
                config_variabels[index].Mode.Value = val;
                console.log(Date.now() + " >> UpdateColorPicker (Mode)" + index + " => " + val + " (" + config_variabels[index].Mode.Value + ")");
            }
        }

        if(isUpdated){
            colorPicker.setColors(GenerateColorData());
        }
    }

    async function PullNewData(refreshRate){
        refreshRate = refreshRate * 1000;
        while (true){
            try {
                $.getJSON("/hook/JSLive/getData?Instance={INSTANCE}&pw={PASSWORD}", function (data) {
                    data.forEach(function (part, index) {
                        UpdateColorPicker(part.Color.Variable, part.Color.Value);
                        UpdateColorPicker(part.Temperature.Variable, part.Temperature.Value);
                        UpdateColorPicker(part.Mode.Variable, part.Mode.Value);
                    });
                });

                //Control Variables
            }catch (e) {
                console.log(Date.now() + " >> PullNewData => ", e);
            }
            await sleep(refreshRate);
        }
    }

    window.onload = function() {
        try {
            if (config_global.LocalAddress == "" && config_global.LocalDataMode == 0) {
                //pullup Mode local
                refreshRate = config_global.LocalRefreshTime;
                PullNewData(refreshRate);
            } else if (config_global.RemoteAddress == "" && config_global.RemoteDataMode == 0) {
                //pullup Mode remote
                refreshRate = config_global.RefreshTime;
                PullNewData(refreshRate);
            } else {
                connect();
            }
        }catch (e) {
            alert("Colorpicker | ", e);
        }
    }
</script>
</body>
</html>